---
- name: Update SSH config
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: 'sshd -t -f %s'
  with_items:
    - regexp: "^PasswordAuthentication"
      line: "PasswordAuthentication no"
    - regexp: "^PermitRootLogin"
      line: "PermitRootLogin no"
  notify: restart ssh

- name: Configure sudoers
  lineinfile:
    dest: /etc/sudoers
    regexp: '^nadavspi'
    line: 'nadavspi ALL=(ALL) NOPASSWD: ALL'
    state: present
    validate: 'visudo -cf %s'

- name: Install unattended upgrades package.
  apt:
    name: unattended-upgrades
    state: present
  when: ansible_os_family == 'Debian'

- name: Copy unattended-upgrades configuration files in place.
  template:
    src: "../templates/{{ item }}.j2"
    dest: "/etc/apt/apt.conf.d/{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - 20auto-upgrades
    - 50unattended-upgrades
  when: ansible_os_family == 'Debian'

- name: Install fail2ban (Debian).
  apt:
    name: fail2ban
    state: present
  when: ansible_os_family == 'Debian'

- name: Ensure fail2ban is running and enabled on boot.
  service:
    name: fail2ban
    state: started
    enabled: yes

- name: Install ufw
  apt:
    name: ufw
    state: present
  when: ansible_os_family == 'Debian'

- name: Configure ufw to allow SSH
  ufw:
    rule: allow
    name: OpenSSH

- name: Configure default incoming/outgoing rules with ufw
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
    state: enabled
  with_items:
    - { direction: outgoing, policy: allow }
    - { direction: incoming, policy: deny }
